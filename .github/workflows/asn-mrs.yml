name: Sync and Fetch ASN MRS Rules

on:
  schedule:
    - cron: '0 18 * * *'  # 北京时间 02:00 执行
  workflow_dispatch:

permissions:
  contents: write

jobs:
  fetch_asn_mrs_rules:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout the repository
      uses: actions/checkout@v4

    - name: Set up Git user
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y jq wget

    - name: Create target directory
      run: mkdir -p rules/IP

    - name: Fetch ASN MRS Rules using GitHub API
      run: |
        cd rules/IP
        # 使用 GitHub API 获取 meta/asn 目录下所有 .mrs 文件的下载链接
        files=$(curl -s "https://api.github.com/repos/MetaCubeX/meta-rules-dat/contents/meta/asn?ref=meta" | jq -r '.[].download_url' | grep '\.mrs$')
        for url in $files; do
          echo "Downloading $url"
          curl -sL "$url" -O
        done
        cd -

    - name: List downloaded files
      run: ls -l rules/IP

    - name: Commit and Push Changes
      run: |
        git add rules/IP
        git diff-index --quiet HEAD -- || (git commit -m "Updated ASN MRS rules" && git push)
