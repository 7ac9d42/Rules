name: Sync and Fetch ASN MRS Rules

on:
  schedule:
    - cron: '0 18 * * *'  # 北京时间 02:00 执行
  workflow_dispatch:

permissions:
  contents: write

jobs:
  fetch_asn_mrs_rules:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout the repository
      uses: actions/checkout@v4

    - name: Set up Git user
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y jq wget

    - name: Create target directory
      run: mkdir -p rules/IP

    - name: Fetch ASN MRS Rules using GitHub API
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        REPO_OWNER="MetaCubeX"
        REPO_NAME="meta-rules-dat"
        DIRECTORY_PATH="meta/asn"
        TARGET_DIR="rules/IP"

        # 获取目录内容的 JSON 列表
        response=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
          "https://api.github.com/repos/$REPO_OWNER/$REPO_NAME/contents/$DIRECTORY_PATH")

        # 解析 JSON 并下载 .mrs 文件
        echo "$response" | jq -r '.[] | select(.name | endswith(".mrs")) | .download_url' | while read -r url; do
          wget -q -P "$TARGET_DIR" "$url"
        done

    - name: Commit and Push Changes
      run: |
        git add .
        git diff-index --quiet HEAD -- || (git commit -m "Updated ASN MRS rules" && git push)
